# MySQL
#TIL/MySQL

## MySQL 엔진 아키텍처
MySQL 서버 = MySQL 엔진 + 스토리지 엔진

### MySQL 엔진
클라이언트 접속 및 쿼리 요청 처리하는 커넥션 핸들러
SQL 파서 및 전처리기
쿼리의 최적화된 실행을 위한 옵티마이저

### 스토리지 엔진
실제 데이터를 디스크 스토리지에 저장하거나 데이터를 읽어오는 부분 전담
MySQL 엔진은 하나를 사용하고 스토리지 엔진은 여러 개를 동시에 사용 가능
MyISAM 스토리지 엔진 (키 캐시)
InnoDB 스토리지 엔진 (InnoDB 버퍼 풀)

### 핸들러(Handler) API
핸들러 요청에 사용되는 API

핸들러(Handler) 요청 : MySQL 엔진의 쿼리 실행기에서 데이터를 쓰거나 읽어야할 때 스토리지 엔진에 보내는 요청

``` 
# 핸들러 API 조회
mysql> SHOW GLABAL STATUS LIKE ‘Handler%’; 
```


## MySQL 스레딩 구조

![](README/C414F661-7644-46D5-B044-0AB023FA29AB.png)

### 포그라운드(Foreground) 스레드
최소 MySQL 서버에 접속된 클라이언트 수만큼 존재
각 클라이언트가 요청하는 쿼리 문장 처리
커넥션 종료시 스레드 캐시(Thread cahce)로 돌아가는데 일정 개수 이상 스레드가 있으면 종료(thread_cache_size)
MyISAM 테이블은 디스크 쓰기 작업까지 포그라운드 스레드가 처리

### 백그라운드(Background) 스레드
인서트 버퍼를 병합
로그를 디스크로 기록
InnoDB 버퍼 풀 데이터를 디스크에 기록
데이터를 버퍼로 읽어옴
잠금이나 데드락 모니터링


## 메모리 구조
### 글로벌 메모리 영역	
	- 테이블 캐시
	- InnoDB 버퍼 풀
	- InnoDB 어댑티브 해시 인덱스
	- InnoDB 리두 로그 버퍼
클라이언트 스레드 수와 무관
모든 스레드에 의해 공유


### 로컬 메모리 영역(세션 메모리 영역)
	- 정렬 버퍼(Sort buffer)
	- 조인 버퍼
	- 바이너리 로그 캐시
	- 네트워크 버퍼
MySQL 서버 상에 존재하는 클라이언트 스레드가 쿼리를 처리하는데 사용
각 클라이언트 스레드별 독립적 할당, 공유되지 않음
각 쿼리의 용도별로 필요할 때만 공간이 할당될 수도 있음

### 플러그인 스토리지 엔진 모델
MySQL의 독특한 구조 중 대표적인 것
전문 검색 엔진을 위한 검색어 파서, 사용자 인증을 위한 Native Authentication 등이 플러그인으로 구현되어 제공
사용자가 직접 스토리지 엔진을 개발할 수 있음

### 컴포넌트
MySQL 8.0 이후 제공되는 아키텍처
플러그인의 단점을 개선
	- MySQL 서버만 인터페이스 가능, 플러그인끼리 통신 불가
	- MySQL 서버의 변수나 함수를 직접 호출 (캡슐화 안됨)
	- 상호 의존 관계 설정할 수 없어 초기화가 어려움


## 쿼리 실행 구조

![](README/DA27BE1F-81D4-4047-91B0-BFB82BEB849F.png)

### 쿼리 파서
사용자 요청으로 들어온 문장을 토큰으로 분리해 트리 구조로 만드는 작업
토큰 : MySQL이 인식할 수 있는 최소 단위의 어휘나 기호

### 전처리기
파서 과정에서 만들어진 파서 트리를 기반으로 쿼리 문장의 문제점 여부 확인
테이블, 컬럼, 함수명 등을 매핑하여 객체 존재여부 및 접근권한 확인

### 옵티마이저
쿼리 문장을 어떻게 적은 비용으로 빠른 처리할지 결정
옵티마이저가 더 나은 선택을 하도록 유도하는 것이 필요

### 실행 엔진
만들어진 계획대로 각 핸들러에 요청한 뒤, 요청 결과를 다른 핸들러 요청의 입력으로 연결

### 핸들러(스토리지 엔진)
데이터를 디스크로 저장하고 디스크로부터 읽어오는 역할(=스토리지 엔진)

## 쿼리 캐시(Query Cache)
SQL 실행 결과를 메모리에 캐시하고 동일한 SQL 쿼리가 실행되면 즉시 결과를 반환
데이터가 변경될 경우 캐시 결과 중 관련 데이터를 모두 삭제하는데, 이 때 동시 처리 성능 저하가 유발되었고, 성능 개선되는 과정에서 많은 버그의 원인이 되면서 MySQL 8.0에서는 제거됨

## 스레드 풀(Thread Pool)
엔터프라이즈 에디션에서는 제공하지만 커뮤니티 에디션은 지원하지 않음

### Percona Server에서 제공하는 스레드 풀
플러그인 형태로 작동
사용자 요청을 처리하는 스레드 개수를 줄여서 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있도록 자원 소모를 줄임


## InnoDB 스토리지 엔진 아키텍처
스토리지 엔진 중 유일하게 레코드 기반 잠금을 제공 -> 높은 동시성 처리
안정적이며 성능이 뛰어남

















