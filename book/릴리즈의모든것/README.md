# 릴리즈의모든것

메모리 누수와 데이터 증가는 테스트 중에는 잘 드러나지 않음

-> 자체적인 장기 안정성 테스트 필요 (JMeter)

커넥션 풀, 방화벽에서 발생하는 타임 아웃 등 일반적인 테스트로 찾기 어려운 현상을 발견할 수 있음

장애 모드(failure mode) : 어떤 원인으로 발생한 균열이 다른 여러 시스템으로 번지는 방식

-> 시스템의 자기 보호가 필요

균열 차단기(crackstopper) : 자동차 엔지니어의 크럼플 존(crumple zone)과 같이 필수 기능에 균열이 번지지 않도록 막음

계층 간의 결합도가 높으면 하나의 문제가 다른 문제를 일으킬 확률이 높아짐

- 결함 : 소프트웨어에 잘못된 내부 상태가 만들어지는 조건
- 오류 : 잘못된 작동을 하는 것
- 장애 : 시스템이 응답을 하지 않는 것

1. 결함은 절대 완벽히 방지할 수 없음
2. 결함이 오류가 되지 않게 막아야 함

**통합 지점** 
서비스와 서비스가 연결되고 통합되는 모든 지점은 문제가 발생할 수 있음

소켓 기반 프로토콜
- 추상화되있는 대부분의 고수준 프로토콜은 소켓 계층에서 발생하는 장애에 취약할 수 있음

HTTP 프로토콜 클라이언트 라이브러리
- 시간 초과와 응답 처리를 정밀하게 제어할 수 있는 라이브러리 사용 필요
- 라이브러리가 응답을 직접 도메인 객체에 매핑하는 것 보다는 내용을 직접 확인 후 추출할 수 있도록 응답을 데이터로 다루는 것이 좋음

업체 제공 클라이언트 라이브러리
- 라이브러리 내에서 자원을 점유하고, 정상적으로 자원이 해제되지 않는다면 교착 상태가 발생할 가능성이 있음

-> 대응책
1. 회로 차단기(circuit breaker)
2. 결합 분리 미들웨어(decoupling middleware)
3. 테스트 하네스(test harness)를 통한 통합 테스트 : 다양한 시스템과 네트워크 장애를 흉내내어 시스템 안정성을 미리 테스트 및 조치

**연쇄 반응**
- 수평적인 클러스터는 부하와 관련된 장애가 발생할 수 있음
- 여러 서버가 있을 때 하나의 서버가 멈추면 다른 서버에 가해지는 부하가 증가하게 됨
- 메모리 누수나 경쟁 상태(race condition)가 발생하는 과부하 상황에서는 같은 계층에 연계 장애를 발생시킴

-> autoscaling 고려, 서버 구역 분할, 회로 차단기 사용

**연계 장애**
- 하위 계층의 장애 때문에 자원 풀이 소진될 때 발생
- 모든 의존 대상은 연계 장애가 일어날 수 있는 위험 요소

-> 회로 차단기, 통합 지점에 대한 시간 제한

**사용자**
트래픽 증가에 따른 처리 능력(capacity) 초과
-> 클라우드 서버의 autoscaling이 도움이 되지만, 버그가 있는 시스템에서는 엄청난 비용이 지출될 수 있음

힙 메모리 절약을 위해 약한 참조(weak reference)를 사용할 수 있음

TCP 패킷의 포트 번호는 16비트 길이로 65,535까지만 사용 가능 

IANA 권장 범위(49,152~65,535)에 따르면 서버는 최대 16,383개의 연결을 열 수 있음

서비스 운영 목적의 경우 최대 64,511개의 연결로 확장 가능함 (1,024~65,535)

서버 하나가 더 많은 연결을 지원하기 위해서는 가상 IP를 사용해 추가 IP 주소를 네트워크 인터페이스에 결합시킴
-> 추가적으로 커널 버퍼나 애플리케이션의 수신 대기열 고갈 없이 모든 IP 주소의 연결을 처리할 수 있도록 변경이 필요해질 수 있음

닫힌 소켓의 TIME_WAIT 상태(다시 사용되기 까지의 지연시간)가 많으면 문제가 발생할 수 있음
-> TIME_WAIT 간격을 낮출 수 있지만, 이전에 사용되던 데이터가 인입될 수 있음





